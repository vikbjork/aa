<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI-Gitarrlärare — Fingerkalibrering</title>
<style>
  :root {
    --bg: #0b0f14; --fg: #e9f0f8; --accent:#6bc3ff; --good:#33d17a;
  }
  html,body {margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,sans-serif;}
  #stage {position:relative;width:100%;height:100vh;overflow:hidden;background:black;}
  video {position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}
  canvas {position:absolute;inset:0;width:100%;height:100%;pointer-events:none;}
  .ui-overlay {position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.5);padding:20px;border-radius:10px;text-align:center;}
  .ui-overlay h2 {margin:0;font-size:32px;}
  .controls {position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;flex-wrap:wrap;gap:8px;}
  button {font-size:16px;padding:10px 14px;border:none;border-radius:8px;background:var(--accent);color:#000;font-weight:600;}
  button:disabled {opacity:0.5;}
</style>
</head>
<body>
<div id="stage">
  <video id="cam" playsinline autoplay muted></video>
  <canvas id="overlay"></canvas>
  <div id="overlayUI" class="ui-overlay">
    <h2 id="instruktion">Tryck "Starta kamera"</h2>
  </div>
  <div class="controls" id="controls">
    <button id="startBtn">Starta kamera</button>
    <button id="saveBtn" disabled>Spara punkt</button>
    <button id="resetBtn" disabled>Rensa</button>
    <button id="dotsBtn" disabled>Em-prickar</button>
    <button id="fsBtn">Fullskärm</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
<script>
const video = document.getElementById('cam');
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');

const instr = document.getElementById('instruktion');
const startBtn = document.getElementById('startBtn');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const dotsBtn = document.getElementById('dotsBtn');
const fsBtn = document.getElementById('fsBtn');

let calibrationBands = [1,3,5,7];
let points = [];
let currentBandIndex = 0;
let showDots = false;
let fingertip = null;
let homography = null;
let wakeLock = null;

function fitCanvas(){canvas.width = stage.clientWidth;canvas.height = stage.clientHeight;}
window.addEventListener('resize',fitCanvas);

function drawOverlay(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(points.length>0){
    ctx.fillStyle='rgba(51,209,122,0.8)';
    points.forEach(p=>{
      ctx.beginPath();ctx.arc(p.x,p.y,6,0,Math.PI*2);ctx.fill();
      ctx.fillText("B"+p.band,p.x+8,p.y);
    });
  }
  if(fingertip){
    ctx.fillStyle='red';
    ctx.beginPath();
    ctx.arc(fingertip.x,fingertip.y,6,0,Math.PI*2);
    ctx.fill();
  }
  if(homography){
    drawNeck();
    if(showDots) drawEmChord();
  }
}

function drawNeck(){
  const strings = 6;
  const frets = 12;
  ctx.strokeStyle='rgba(255,255,255,0.4)';
  for(let f=0; f<=frets; f++){
    const y = f/12;
    ctx.beginPath();
    ctx.moveTo(0,canvas.height*y);
    ctx.lineTo(canvas.width,canvas.height*y);
    ctx.stroke();
  }
  ctx.strokeStyle='rgba(255,255,255,0.3)';
  for(let s=0; s<strings; s++){
    const x = s/(strings-1);
    ctx.beginPath();
    ctx.moveTo(canvas.width*x,0);
    ctx.lineTo(canvas.width*x,canvas.height);
    ctx.stroke();
  }
}

function drawEmChord(){
  // Em = band 2 på A(1) och D(2) sträng
  const strings = [1,2];
  strings.forEach(s=>{
    const x = s/(5);
    const y = 2/12;
    ctx.fillStyle='rgba(51,209,122,0.9)';
    ctx.beginPath();
    ctx.arc(canvas.width*x,canvas.height*y,8,0,Math.PI*2);
    ctx.fill();
  });
}

function nextInstruction(){
  if(currentBandIndex < calibrationBands.length){
    instr.textContent = `Placera fingret på band ${calibrationBands[currentBandIndex]}`;
  } else {
    instr.textContent = `Kalibrering klar — välj ackord`;
  }
}

function savePoint(){
  if(!fingertip) return;
  points.push({band:calibrationBands[currentBandIndex],x:fingertip.x,y:fingertip.y});
  currentBandIndex++;
  if(currentBandIndex >= calibrationBands.length){
    homography = {}; // placeholder för riktig matris
    saveBtn.disabled=true;
    resetBtn.disabled=false;
    dotsBtn.disabled=false;
    instr.textContent = "Kalibrering klar — klicka 'Em-prickar'";
  } else {
    nextInstruction();
  }
}

function resetCal(){
  points=[];currentBandIndex=0;homography=null;
  saveBtn.disabled=false;dotsBtn.disabled=true;
  resetBtn.disabled=true;showDots=false;
  nextInstruction();
}

function toggleDots(){
  showDots = !showDots;
}

fsBtn.addEventListener('click',()=>{if(stage.requestFullscreen)stage.requestFullscreen();});

startBtn.addEventListener('click',()=>{
  fitCanvas();
  hands.setOptions({
    maxNumHands:1,
    modelComplexity:0,
    minDetectionConfidence:0.6,
    minTrackingConfidence:0.6
  });
  const camera = new Camera(video, {
    onFrame: async()=>{await hands.send({image:video});},
    width:1280,height:720
  });
  camera.start();
  saveBtn.disabled=false;
  currentBandIndex=0;
  nextInstruction();
  requestWakeLock();
});

saveBtn.addEventListener('click',savePoint);
resetBtn.addEventListener('click',resetCal);
dotsBtn.addEventListener('click',toggleDots);

// MediaPipe
const hands = new Hands({locateFile: (file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.onResults(results=>{
  ctx.drawImage(results.image,0,0,canvas.width,canvas.height);
  if(results.multiHandLandmarks && results.multiHandLandmarks.length>0){
    const tip = results.multiHandLandmarks[0][8];
    fingertip = {x:(1-tip.x)*canvas.width,y:tip.y*canvas.height};
  } else {
    fingertip=null;
  }
  drawOverlay();
});

// Wake lock
async function requestWakeLock(){
  try{wakeLock = await navigator.wakeLock.request('screen');}catch(e){console.log(e);}
}
</script>
</body>
</html>
