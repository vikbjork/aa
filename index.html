<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gratis saker n√§ra dig</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  :root{--bg:#0b0f14;--card:#121821;--fg:#e9f0f8;--muted:#a6b3c2;--accent:#6bc3ff;--good:#33d17a}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  .app{display:grid;grid-template-columns:380px 1fr;gap:12px;max-width:1400px;margin:0 auto;padding:12px}
  @media(max-width:900px){.app{grid-template-columns:1fr;grid-template-rows:45dvh 55dvh}}
  .panel{background:var(--card);border:1px solid #1f2732;border-radius:14px;overflow:hidden}
  header{padding:14px 16px;border-bottom:1px solid #1f2732;display:flex;justify-content:space-between;align-items:center}
  header h1{margin:0;font-size:18px}
  .filters{display:flex;gap:8px;flex-wrap:wrap}
  .filter{display:inline-flex;align-items:center;gap:8px;border:1px solid #2a3443;background:#16202d;padding:6px 10px;border-radius:999px;cursor:pointer}
  .filter input{accent-color:#6bc3ff}
  #list{padding:8px;overflow:auto;max-height:calc(100% - 52px)}
  .card{display:grid;grid-template-columns:72px 1fr;gap:10px;padding:10px;border-bottom:1px solid #1f2732;cursor:pointer}
  .thumb{width:72px;height:72px;background:#0a0f15;border:1px solid #1f2732;border-radius:8px;object-fit:cover}
  .title{margin:0 0 4px;font-weight:700}
  .meta{font-size:13px;color:var(--muted)}
  .tags{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
  .tag{font-size:12px;border:1px solid #2a3443;background:#101722;padding:3px 8px;border-radius:999px}
  #map{height:100%;width:100%}
  .toolbar{display:flex;gap:8px;align-items:center}
  .btn{border:1px solid #2a3443;background:#16202d;color:var(--fg);padding:8px 10px;border-radius:10px;cursor:pointer}
  .geoStatus{font-size:12px;color:var(--muted)}
  .empty{padding:16px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="app">
  <div class="panel">
    <header>
      <h1>üÜì Gratis saker n√§ra dig</h1>
      <div class="toolbar">
        <button id="locate" class="btn">üìç Min plats</button>
      </div>
    </header>
    <div class="filters" style="padding:10px">
      <label class="filter"><input type="checkbox" id="fltGratis" checked> <span>#gratis</span></label>
      <label class="filter"><input type="checkbox" id="fltBort" checked> <span>#bortsk√§nkes</span></label>
      <span id="geo" class="geoStatus">V√§ntar p√• plats‚Ä¶</span>
    </div>
    <div id="list"></div>
  </div>

  <div class="panel">
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- Demo-data (byt/ut√∂ka senare via fetch till din egen endpoint) ---
const items = [
  {
    id:"1",
    title:"Soffa 3-sits",
    desc:"H√§mtas p√• plats. F√∂rst till kvarn.",
    lat:59.334, lng:18.063, // Stockholm C
    photo:"https://images.unsplash.com/photo-1519710164239-da123dc03ef4?w=400",
    tags:["gratis","bortsk√§nkes"],
    url:"#"
  },
  {
    id:"2",
    title:"Barncykel 20 tum",
    desc:"Fungerar bra, bara att h√§mta.",
    lat:59.306, lng:18.000,
    photo:"https://images.unsplash.com/photo-1519741497674-611481863552?w=400",
    tags:["bortsk√§nkes"],
    url:"#"
  },
  {
    id:"3",
    title:"Tallrikar & glas",
    desc:"Flyttrens ‚Äì sk√§nkes idag.",
    lat:59.360, lng:18.050,
    photo:"https://images.unsplash.com/photo-1497534547324-0ebb3f052e88?w=400",
    tags:["gratis"],
    url:"#"
  }
];

// --- State ---
let userPos = {lat:59.3293, lng:18.0686}; // fallback: Stockholm
let map, markers = [];
const listEl = document.getElementById('list');
const fltGratis = document.getElementById('fltGratis');
const fltBort = document.getElementById('fltBort');
const geoEl = document.getElementById('geo');

// --- Map init ---
map = L.map('map', {zoomControl:true}).setView([userPos.lat, userPos.lng], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'¬© OpenStreetMap'
}).addTo(map);

function setUserMarker(){
  const circle = L.circle([userPos.lat, userPos.lng], {radius:80, color:'#6bc3ff', fillColor:'#6bc3ff', fillOpacity:0.2});
  circle.addTo(map);
}

// --- Geo ---
function locateUser(){
  if(!navigator.geolocation){ geoEl.textContent = "Geolocation saknas."; return; }
  geoEl.textContent = "H√§mtar plats‚Ä¶";
  navigator.geolocation.getCurrentPosition(
    p=>{
      userPos = {lat:p.coords.latitude, lng:p.coords.longitude};
      geoEl.textContent = `Din plats: ${userPos.lat.toFixed(4)}, ${userPos.lng.toFixed(4)}`;
      map.setView([userPos.lat, userPos.lng], 13);
      setUserMarker();
      render();
    },
    err=>{
      geoEl.textContent = "Plats nekad ‚Äì visar Stockholm.";
      setUserMarker();
      render();
    },
    {enableHighAccuracy:true, timeout:8000, maximumAge:60000}
  );
}
document.getElementById('locate').addEventListener('click', locateUser);
locateUser(); // auto vid start

// --- Helpers ---
function haversine(a,b){
  const toRad = d=>d*Math.PI/180;
  const R=6371; // km
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const lat1=toRad(a.lat), lat2=toRad(b.lat);
  const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}
function passesFilters(it){
  const wantGratis = fltGratis.checked;
  const wantBort = fltBort.checked;
  const hasGratis = it.tags.includes("gratis");
  const hasBort = it.tags.includes("bortsk√§nkes");
  return (!wantGratis || hasGratis) && (!wantBort || hasBort);
}

// --- Render ---
function render(){
  // rensa markers
  markers.forEach(m=>m.remove());
  markers = [];

  // filtrera + sortera efter avst√•nd
  const filtered = items.filter(passesFilters).map(it=>{
    const km = haversine(userPos,{lat:it.lat, lng:it.lng});
    return {...it, km};
  }).sort((a,b)=>a.km-b.km);

  // lista
  listEl.innerHTML = '';
  if(filtered.length===0){
    listEl.innerHTML = '<div class="empty">Inga tr√§ffar med valda filter.</div>';
  }
  filtered.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img class="thumb" src="${it.photo}" alt="">
      <div>
        <div class="title">${it.title}</div>
        <div class="meta">${it.km.toFixed(1)} km ‚Ä¢ ${it.desc||''}</div>
        <div class="tags">
          ${it.tags.map(t=>`<span class="tag">#${t}</span>`).join('')}
        </div>
      </div>`;
    card.addEventListener('click', ()=>{
      map.setView([it.lat,it.lng], 15, {animate:true});
      markers.find(m=>m.itemId===it.id)?.openPopup();
    });
    listEl.appendChild(card);

    // marker
    const marker = L.marker([it.lat,it.lng]).addTo(map)
      .bindPopup(`<strong>${it.title}</strong><br>${it.desc||''}<br><a href="${it.url}" target="_blank" rel="noopener">√ñppna annons</a>`);
    marker.itemId = it.id;
    markers.push(marker);
  });
}
fltGratis.addEventListener('change', render);
fltBort.addEventListener('change', render);
render();
</script>
</body>
</html>
