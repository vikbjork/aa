<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üÜì Gratis n√§ra mig</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  :root{
    --bg:#0b1016; --card:#121826; --fg:#e8eef6; --muted:#9fb0c6; --line:#1f2a3a;
    --accent:#6bc3ff; --chip:#0f1828;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  .app{display:grid;grid-template-columns:420px 1fr;gap:14px;max-width:1500px;margin:0 auto;padding:14px}
  @media (max-width:1000px){ .app{grid-template-columns:1fr; grid-template-rows:48dvh 52dvh;} }
  .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:18px}
  .toolbar{display:flex;gap:8px;align-items:center}
  .btn{border:1px solid var(--line);background:#162335;color:var(--fg);padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:600}
  .chips{display:flex;gap:8px;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid var(--line)}
  .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px}
  .chip input{accent-color:var(--accent)}
  #geo{margin-left:auto;color:var(--muted);font-size:12px}
  .search{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid var(--line)}
  .search input{flex:1; padding:10px;border:1px solid var(--line);background:#0f1726;color:var(--fg);border-radius:10px}
  .search button{padding:10px 12px;border:1px solid var(--line);background:#162335;color:var(--fg);border-radius:10px;cursor:pointer}
  #list{height:calc(100% - 160px);overflow:auto}
  .empty{padding:18px;color:var(--muted);text-align:center}
  .card{display:grid;grid-template-columns:96px 1fr;gap:12px;padding:12px;border-bottom:1px solid var(--line);cursor:pointer}
  .thumb{width:96px;height:96px;border-radius:10px;object-fit:cover;background:#0b111c;border:1px solid var(--line)}
  .title{margin:0 0 6px;font-weight:800}
  .meta{font-size:13px;color:var(--muted)}
  .tags{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
  .tag{font-size:12px;border:1px solid var(--line);background:#0f1726;padding:3px 8px;border-radius:999px}
  #map{height:100%;width:100%}
  .loader{padding:12px}
  .skeleton{height:96px;border-radius:10px;background:linear-gradient(90deg,#0c1523,#0e1a2b,#0c1523);background-size:200% 100%;animation:shine 1.1s infinite;margin-bottom:10px}
  @keyframes shine{0%{background-position:200% 0}100%{background-position:-200% 0}}
</style>
</head>
<body>
<div class="app">
  <!-- Lista -->
  <div class="panel">
    <header>
      <h1>üÜì Gratis n√§ra mig</h1>
      <div class="toolbar">
        <button id="gpsBtn" class="btn">üìç Min plats</button>
        <button id="refreshBtn" class="btn">‚Üª Uppdatera</button>
      </div>
    </header>

    <div class="chips">
      <label class="chip"><input type="checkbox" id="fltGratis" checked> <span>#gratis</span></label>
      <label class="chip"><input type="checkbox" id="fltBort" checked> <span>#bortsk√§nkes</span></label>
      <span id="geo">V√§ntar p√• plats‚Ä¶</span>
    </div>

    <div class="search">
      <input id="city" type="text" placeholder="Skriv stad (t.ex. Malm√∂, G√∂teborg)‚Ä¶">
      <button id="cityBtn">S√∂k</button>
    </div>

    <div id="list">
      <div class="loader">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>
    </div>
  </div>

  <!-- Karta -->
  <div class="panel"><div id="map"></div></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API = '/api/fynd'; // Vercel serverless
let userPos = null;
let map, markers=[], dataCache=[];
const geoEl = document.getElementById('geo');
const listEl = document.getElementById('list');
const fltGratis = document.getElementById('fltGratis');
const fltBort = document.getElementById('fltBort');

function initMap(){
  map = L.map('map',{zoomControl:true}).setView([59.3293,18.0686], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19, attribution:'¬© OpenStreetMap'
  }).addTo(map);
}
function setUserMarker(){
  if(!userPos) return;
  const circle = L.circle([userPos.lat, userPos.lng], {radius:120,color:'#6bc3ff',fillColor:'#6bc3ff',fillOpacity:.18});
  circle.addTo(map);
  map.setView([userPos.lat,userPos.lng], 12);
}

function km(a,b){const R=6371,dLat=(b.lat-a.lat)*Math.PI/180,dLng=(b.lng-a.lng)*Math.PI/180;
  const s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);
  const q=s1*s1 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*s2*s2;
  return 2*R*Math.asin(Math.sqrt(q));
}
function passesFilters(it){
  const g=fltGratis.checked,b=fltBort.checked;
  const tg=it.tags?.includes('gratis'), tb=it.tags?.includes('bortsk√§nkes');
  return (!g || tg) && (!b || tb);
}
function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }

function render(){
  if(!dataCache.length){ listEl.innerHTML='<div class="empty">Inga fynd √§nnu‚Ä¶</div>'; clearMarkers(); return; }
  const arr = dataCache.filter(passesFilters).map(it=>{
    if(userPos && it.lat && it.lng) it.km = km(userPos,{lat:it.lat,lng:it.lng}); else it.km=null; return it;
  }).sort((a,b)=>{
    if(a.km===null && b.km===null) return 0;
    if(a.km===null) return 1; if(b.km===null) return -1;
    return a.km-b.km;
  });

  listEl.innerHTML='';
  if(!arr.length) listEl.innerHTML='<div class="empty">Inga tr√§ffar med valda filter.</div>';

  arr.forEach(it=>{
    const card=document.createElement('div'); card.className='card';
    const photo = it.photo || 'https://images.unsplash.com/photo-1524758631624-e2822e304c36?w=400';
    card.innerHTML=`
      <img class="thumb" src="${photo}" alt="">
      <div>
        <div class="title">${it.title||'Utan titel'}</div>
        <div class="meta">${it.km!=null? it.km.toFixed(1)+' km':'ok√§nt avst√•nd'} ‚Ä¢ ${it.source||''}</div>
        <div class="tags">${(it.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join('')}</div>
      </div>`;
    card.addEventListener('click',()=>{ if(it.lat&&it.lng){map.setView([it.lat,it.lng],14,{animate:true}); markers.find(m=>m._id===it.id)?.openPopup();} window.open(it.url,'_blank','noopener');});
    listEl.appendChild(card);
  });

  clearMarkers();
  arr.forEach(it=>{
    if(!(it.lat&&it.lng)) return;
    const m=L.marker([it.lat,it.lng]).addTo(map).bindPopup(`<strong>${it.title||''}</strong><br>${it.source||''}<br><a href="${it.url}" target="_blank" rel="noopener">√ñppna annons</a>`);
    m._id=it.id; markers.push(m);
  });
}

async function fetchData(){
  listEl.innerHTML = `<div class="loader"><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div></div>`;
  try{
    const qs=new URLSearchParams();
    if(userPos){ qs.set('lat',userPos.lat); qs.set('lng',userPos.lng); }
    qs.set('tags','gratis,bortsk√§nkes');
    const r=await fetch(\`${API}?\${qs.toString()}\`);
    const j=await r.json();
    dataCache=j.items||[];
  }catch(e){ console.log(e); dataCache=[]; }
  render();
}

function tryGPS(){
  geoEl.textContent='F√∂rs√∂ker GPS‚Ä¶';
  if(!navigator.geolocation){
    geoEl.textContent='GPS saknas ‚Äì skriv stad.';
    return;
  }
  navigator.geolocation.getCurrentPosition(
    p=>{ userPos={lat:p.coords.latitude, lng:p.coords.longitude}; geoEl.textContent=`Plats: ${userPos.lat.toFixed(4)}, ${userPos.lng.toFixed(4)}`; setUserMarker(); fetchData(); },
    _=>{ geoEl.textContent='GPS nekad/timeout ‚Äì skriv stad.'; },
    {enableHighAccuracy:true, timeout:8000, maximumAge:60000}
  );
}

async function geocodeCity(city){
  if(!city) return;
  geoEl.textContent=`S√∂ker: ${city}‚Ä¶`;
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
    const j=await r.json();
    if(j && j.length){ userPos={lat:parseFloat(j[0].lat), lng:parseFloat(j[0].lon)}; geoEl.textContent=`Plats satt: ${city}`; setUserMarker(); fetchData(); }
    else geoEl.textContent='Hittade ingen plats.';
  }catch(e){ geoEl.textContent='Fel vid s√∂kning.'; }
}

// UI hooks
document.getElementById('gpsBtn').addEventListener('click', tryGPS);
document.getElementById('refreshBtn').addEventListener('click', fetchData);
document.getElementById('cityBtn').addEventListener('click', ()=> geocodeCity(document.getElementById('city').value));
document.getElementById('city').addEventListener('keydown', e=>{ if(e.key==='Enter') geocodeCity(e.target.value); });
fltGratis.addEventListener('change', render);
fltBort.addEventListener('change', render);

// start
initMap();
tryGPS();        // f√∂rs√∂k GPS direkt
fetchData();     // f√∂rsta laddning (utan position ger √§nd√• lista)
</script>
</body>
</html>
