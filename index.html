<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üÜì Gratis n√§ra mig</title>
<link rel="icon" href="/app-icon.png" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  :root{
    --bg:#0b1016; --card:#121826; --fg:#e8eef6; --muted:#9fb0c6; --line:#1f2a3a;
    --accent:#6bc3ff; --accent2:#33d17a; --chip:#101a2a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  .app{display:grid;grid-template-columns:420px 1fr;gap:14px;max-width:1500px;margin:0 auto;padding:14px}
  @media (max-width:1000px){ .app{grid-template-columns:1fr; grid-template-rows:50dvh 50dvh;} }
  .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:18px;letter-spacing:0.2px}
  .toolbar{display:flex;gap:8px;align-items:center}
  .btn{border:1px solid var(--line);background:#162335;color:var(--fg);padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .chips{display:flex;gap:8px;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid var(--line)}
  .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px}
  .chip input{accent-color:var(--accent)}
  #geo{margin-left:auto;color:var(--muted);font-size:12px}
  #list{height:calc(100% - 106px);overflow:auto}
  .card{display:grid;grid-template-columns:96px 1fr;gap:12px;padding:12px;border-bottom:1px solid var(--line);cursor:pointer}
  .thumb{width:96px;height:96px;border-radius:10px;object-fit:cover;background:#0b111c;border:1px solid var(--line)}
  .title{margin:0 0 6px;font-weight:800}
  .meta{font-size:13px;color:var(--muted)}
  .tags{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
  .tag{font-size:12px;border:1px solid var(--line);background:#0f1726;padding:3px 8px;border-radius:999px}
  .empty{padding:18px;color:var(--muted);text-align:center}
  #map{height:100%;width:100%}
  .topbar{display:flex;gap:8px;align-items:center}
  .search{flex:1;display:flex;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0f1726}
  .search input{all:unset;padding:8px 10px;flex:1;color:var(--fg)}
  .search button{all:unset;padding:8px 10px;cursor:pointer;color:var(--muted)}
  .loader{padding:12px}
  .skeleton{height:96px;border-radius:10px;background:linear-gradient(90deg,#0c1523,#0e1a2b,#0c1523);background-size:200% 100%;animation:shine 1.1s infinite}
  @keyframes shine{0%{background-position:200% 0}100%{background-position:-200% 0}}
</style>
</head>
<body>
<div class="app">
  <!-- V√§nster panel: lista + filter -->
  <div class="panel">
    <header>
      <div class="topbar">
        <h1>üÜì Gratis n√§ra mig</h1>
      </div>
      <div class="toolbar">
        <button id="locate" class="btn">üìç Min plats</button>
        <button id="refresh" class="btn">‚Üª Uppdatera</button>
      </div>
    </header>
    <div class="chips">
      <label class="chip"><input type="checkbox" id="fltGratis" checked> <span>#gratis</span></label>
      <label class="chip"><input type="checkbox" id="fltBort" checked> <span>#bortsk√§nkes</span></label>
      <span id="geo">V√§ntar p√• plats‚Ä¶</span>
    </div>
    <div id="list">
      <div class="loader">
        <div class="skeleton" style="margin-bottom:10px"></div>
        <div class="skeleton" style="margin-bottom:10px"></div>
        <div class="skeleton"></div>
      </div>
    </div>
  </div>

  <!-- H√∂ger panel: karta -->
  <div class="panel">
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API = '/api/fynd'; // Vercel serverless route
let userPos = null;
let map, markers=[], dataCache=[];
const listEl = document.getElementById('list');
const fltGratis = document.getElementById('fltGratis');
const fltBort = document.getElementById('fltBort');
const geoEl = document.getElementById('geo');

function initMap(){
  map = L.map('map',{zoomControl:true}).setView([59.3293,18.0686], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map);
}

function setUserMarker(){
  if(!userPos) return;
  const circle = L.circle([userPos.lat,userPos.lng],{radius:100,color:'#6bc3ff',fillColor:'#6bc3ff',fillOpacity:0.18});
  circle.addTo(map);
  map.setView([userPos.lat,userPos.lng], 12);
}

function locateUser(){
  if(!navigator.geolocation){ geoEl.textContent='Plats saknas'; return; }
  geoEl.textContent='H√§mtar plats‚Ä¶';
  navigator.geolocation.getCurrentPosition(
    p=>{
      userPos = {lat:p.coords.latitude, lng:p.coords.longitude};
      geoEl.textContent = `Plats: ${userPos.lat.toFixed(4)}, ${userPos.lng.toFixed(4)}`;
      setUserMarker();
      render();
    },
    _=>{
      geoEl.textContent='Plats nekad ‚Äì visar Stockholm';
      render();
    },
    {enableHighAccuracy:true, timeout:8000, maximumAge:60000}
  );
}

function km(a,b){
  const R=6371, dLat=(b.lat-a.lat)*Math.PI/180, dLng=(b.lng-a.lng)*Math.PI/180;
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  const q=s1*s1 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*s2*s2;
  return 2*R*Math.asin(Math.sqrt(q));
}

function passesFilters(it){
  const g=fltGratis.checked, b=fltBort.checked;
  const tg=it.tags?.includes('gratis'), tb=it.tags?.includes('bortsk√§nkes');
  return (!g || tg) && (!b || tb);
}

function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }

function render(){
  if(!dataCache.length){
    listEl.innerHTML = '<div class="empty">Inga fynd √§nnu‚Ä¶</div>';
    clearMarkers(); return;
  }
  const filtered = dataCache.filter(passesFilters).map(it=>{
    if(userPos && it.lat && it.lng) it.km = km(userPos,{lat:it.lat,lng:it.lng}); else it.km = null;
    return it;
  }).sort((a,b)=>{
    if(a.km===null && b.km===null) return 0;
    if(a.km===null) return 1;
    if(b.km===null) return -1;
    return a.km-b.km;
  });

  // Lista
  listEl.innerHTML='';
  if(!filtered.length){
    listEl.innerHTML = '<div class="empty">Inga tr√§ffar med valda filter.</div>';
  }
  filtered.forEach(it=>{
    const card=document.createElement('div'); card.className='card';
    const photo = it.photo || 'https://images.unsplash.com/photo-1524758631624-e2822e304c36?w=400';
    card.innerHTML = `
      <img class="thumb" src="${photo}" alt="">
      <div>
        <div class="title">${it.title||'Utan titel'}</div>
        <div class="meta">${it.km!=null ? it.km.toFixed(1)+' km' : 'ok√§nt avst√•nd'} ‚Ä¢ ${it.source||'k√§lla'}</div>
        <div class="tags">${(it.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join('')}</div>
      </div>`;
    card.addEventListener('click',()=>{
      if(it.lat && it.lng){ map.setView([it.lat,it.lng], 14, {animate:true}); markers.find(m=>m._id===it.id)?.openPopup(); }
      window.open(it.url,'_blank','noopener');
    });
    listEl.appendChild(card);
  });

  // Kartmark√∂rer
  clearMarkers();
  filtered.forEach(it=>{
    if(!(it.lat && it.lng)) return;
    const m=L.marker([it.lat,it.lng]).addTo(map).bindPopup(`<strong>${it.title||''}</strong><br>${it.source||''}<br><a href="${it.url}" target="_blank" rel="noopener">√ñppna annons</a>`);
    m._id = it.id; markers.push(m);
  });
}

async function fetchData(){
  listEl.innerHTML = `
    <div class="loader">
      <div class="skeleton" style="margin-bottom:10px"></div>
      <div class="skeleton" style="margin-bottom:10px"></div>
      <div class="skeleton"></div>
    </div>`;
  try{
    const qs = new URLSearchParams();
    if(userPos){ qs.set('lat', userPos.lat); qs.set('lng', userPos.lng); }
    qs.set('tags','gratis,bortsk√§nkes');
    const res = await fetch(\`${API}?\${qs.toString()}\`);
    const json = await res.json();
    dataCache = json.items || [];
  }catch(e){
    console.log(e);
    dataCache = [];
  }
  render();
}

document.getElementById('locate').addEventListener('click', ()=> locateUser());
document.getElementById('refresh').addEventListener('click', fetchData);
fltGratis.addEventListener('change', render);
fltBort.addEventListener('change', render);

initMap();
locateUser();
fetchData();
</script>
</body>
</html>
